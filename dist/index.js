"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var http=require("http"),http2=require("http2"),crypto=require("crypto"),fs=require("fs");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var http__default=_interopDefaultLegacy(http),http2__default=_interopDefaultLegacy(http2),fs__default=_interopDefaultLegacy(fs);function CreateContext(e,t){const{method:r,url:s,headers:a}=e,{statusCode:i,write:n,end:o,setHeader:d}=t;var[u,f]=(s||"").split("?");return{reqOption:{_req:e,method:r||"",pathName:u,query:new URLSearchParams(f),fullPath:s||"",headers:a},resOption:{_res:t,statusCode:i,setHeader:d.bind(t),send:n.bind(t),end:o.bind(t)}}}function CreateHttp2Context(e,t){const{method:r,url:s,headers:a}=e,{statusCode:i,write:n,end:o,setHeader:d}=t;var[u,f]=(s||"").split("?");return{reqOption:{_req:e,method:r||"",pathName:u,query:new URLSearchParams(f),fullPath:s||"",headers:a},resOption:{_res:t,statusCode:i,setHeader:d.bind(t),send:n.bind(t),end:o.bind(t)}}}class HttpFramework{serverApp;middleWareArr;data;constructor(e={}){this.serverApp=null,this.middleWareArr=[],this.data=e,this.init()}init(){let e=null;var t,r;e=this.data.http2?({key:t,cert:r}=this.data,http2__default.default.createSecureServer({key:t,cert:r},(e,t)=>{var{reqOption:e,resOption:t}=CreateHttp2Context(e,t);runMiddleWare(this.middleWareArr,e,t)})):http__default.default.createServer((e,t)=>{var{reqOption:e,resOption:t}=CreateContext(e,t);runMiddleWare(this.middleWareArr,e,t)}),this.serverApp=e}use(e){if("function"!=typeof e)throw new Error("middle ware must be a function");this.middleWareArr.push(e)}listen(e,t=()=>{}){this.serverApp?.listen(e,t)}}async function runMiddleWare(t,r,s){if(0===t.length)return s.send("404 not found"),void s.end();let a=0;await t[0](r,s,async function e(){t[a+1]&&(a++,await t[a](r,s,e))})}class Router{routeList;data;constructor(e={}){this.routeList=[],this.data=e}use(e){this.routeList=this.routeList.concat(e.routeList)}set(e,t,r){let s=[];var a="string"==typeof t?t.split("/").filter(e=>""!==e):[];this.data.prefix&&(s=this.data.prefix.split("/").filter(e=>""!==e)),this.routeList.push({method:e,prefix:this.data.prefix,path:""+t,pathArr:s.concat(a),businessFunc:r,param:{}})}get(e,t){this.set("GET",e,t)}put(e,t){this.set("PUT",e,t)}delete(e,t){this.set("DELETE",e,t)}post(e,t){this.set("POST",e,t)}option(e,t){this.set("OPTION",e,t)}routes(){return async(t,r,s)=>{const e=t.pathName;var a,i=e.split("/").filter(e=>""!==e);for(a of this.routeList)if(a.method===t.method)if("string"==typeof a.path){const d={},u=a.pathArr;let e=!0;if(u.length===i.length){for(var[n,o]of Object.entries(i)){n=Number(n);if(!/^\:.*$/.test(u[n])&&o!==u[n]){e=!1;break}":"===u[n][0]&&(d[u[n].substring(1,u[n].length)]=o)}if(e)return a.param=d,void(t.route=a).businessFunc(t,r,s)}}else if(a.path.test(e))return void(t.route=a).businessFunc(t,r,s);r.send("404 not found"),r.end()}}}function staticData({pathName:i="",prefix:n="",expire:o=0,cache:d=!1}){const u=fs.existsSync(i);return u||console.warn(`file static: ${i} is not exists`),async(e,t,r)=>{var s=i+n+e.pathName;if(u){var a=await checkIsExists(s);if(a||checkIsFile(s)){if(console.log(a,s),e.headers["if-none-match"]&&e.headers["if-none-match"]===getHash(i))return void(t._res.statusCode=304);0<o&&t.setHeader("Cache-Control","max-age="+o),d&&t.setHeader("etag",getHash(i)),fs__default.default.createReadStream(s).pipe(t._res)}else t.send("404 not found")}await r()}}function getHash(e){return crypto.createHash("md5").update(e).end().digest("hex")}function checkIsExists(e){return new Promise(t=>{fs__default.default.access(e,fs.constants.F_OK,e=>{t(!e)})})}function checkIsFile(s){return new Promise(r=>{fs__default.default.stat(s,(e,t)=>{if(e)return console.log(s+" is not found"),void r(!1);r(t.isFile())})})}function BodyParse(){return async(t,e,r)=>{let s=Buffer.from([]);t._req.on("data",e=>{s=Buffer.concat([s,e])}),t._req.on("end",async()=>{try{var e=JSON.parse(s.toString()||"{}");t.body=e}catch{}finally{t.bodyBuf=s,await r()}})}}exports.BodyParse=BodyParse,exports.Router=Router,exports.Server=HttpFramework,exports.Static=staticData;
