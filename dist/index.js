"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var http=require("http"),crypto=require("crypto"),fs=require("fs");function _interopDefaultLegacy(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var http__default=_interopDefaultLegacy(http),fs__default=_interopDefaultLegacy(fs);class HttpFramework{serverApp;middleWareArr;constructor(){this.serverApp=null,this.middleWareArr=[],this.init()}init(){var t=http__default.default.createServer((t,e)=>{var{reqOption:t,resOption:e}=createContext(t,e);runMiddleWare(this.middleWareArr,t,e)});this.serverApp=t}use(t){if("function"!=typeof t)throw new Error("middle ware must be a function");this.middleWareArr.push(t)}listen(t,e=()=>{}){this.serverApp?.listen(t,e)}}async function runMiddleWare(e,r,s){0===e.length&&(s.send("404 not found"),s.end());let i=0;await e[0](r,s,async function t(){e[i+1]&&(i++,await e[i](r,s,t))})}function createContext(t,e){const{method:r,url:s,headers:i}=t,{statusCode:a,write:n,end:f,setHeader:c}=e,[p,o]=(s||"").split("?"),u={};if(o){const d=o.split("&");d.forEach(t=>{var[t,e]=decodeURIComponent(t).split("=");t&&(u[t]=e)})}return{reqOption:{_req:t,method:r,pathName:p,query:u,fullPath:s||"",headers:i},resOption:{_res:e,statusCode:a,setHeader:c.bind(e),send:n.bind(e),end:f.bind(e)}}}class Router{routeList;data;constructor(t={}){this.routeList=[],this.data=t}use(t){this.routeList=this.routeList.concat(t.routeList)}set(t,e,r){let s=[];var i="string"==typeof e?e.split("/").filter(t=>""!==t):[];this.data.prefix&&(s=this.data.prefix.split("/").filter(t=>""!==t)),this.routeList.push({method:t,prefix:this.data.prefix,path:""+e,pathArr:s.concat(i),businessFunc:r,param:{}})}get(t,e){this.set("GET",t,e)}put(t,e){this.set("PUT",t,e)}delete(t,e){this.set("DELETE",t,e)}post(t,e){this.set("POST",t,e)}option(t,e){this.set("OPTION",t,e)}routes(){return async(e,r,s)=>{const t=e.pathName;var i,a=t.split("/").filter(t=>""!==t);for(i of this.routeList)if("string"==typeof i.path){const u={},d=i.pathArr;let t=!0;if(d.length===a.length){for(var[n,o]of Object.entries(a)){n=Number(n);if(!/^\:.*$/.test(d[n])&&o!==d[n]){t=!1;break}":"===d[n][0]&&(u[d[n].substring(1,d[n].length)]=o)}if(t)return i.param=u,void(e.route=i).businessFunc(e,r,s)}}else if(i.path.test(t))return void(e.route=i).businessFunc(e,r,s);await s()}}}function staticData({pathName:i="",prefix:a="",expire:n=0,cache:o=!1}){const u=fs.existsSync(i);return u||console.warn(`file static: ${i} is not exists`),async(t,e,r)=>{var s=i+a+t.pathName;if(u)if(await checkIsExists(s)){if(t.headers["if-modified-since"]&&t.headers["if-modified-since"]===getHash(i))return e._res.statusCode=304,void e.end();0<n&&e.setHeader("Cache-Control","max-age="+n),o&&e.setHeader("last-modified",getHash(i)),fs__default.default.createReadStream(s).pipe(e._res)}else e.send("404 not found"),e.end();await r()}}function getHash(t){return crypto.createHash("md5").update(t).end().digest("hex")}function checkIsExists(t){return new Promise(e=>{fs__default.default.access(t,fs.constants.F_OK,t=>{e(!t)})})}exports.Router=Router,exports.Server=HttpFramework,exports.Static=staticData;
