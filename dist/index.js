"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var http=require("http"),http2=require("http2"),crypto=require("crypto"),fs=require("fs");function _interopDefaultLegacy(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var http__default=_interopDefaultLegacy(http),http2__default=_interopDefaultLegacy(http2),fs__default=_interopDefaultLegacy(fs);function CreateContext(t,e){const{method:r,url:a,headers:s}=t,{statusCode:i,write:n,end:o,setHeader:d}=e;var[u,h]=(a||"").split("?");return{reqOption:{_req:t,method:r||"",pathName:u,query:new URLSearchParams(h),fullPath:a||"",headers:s},resOption:{_res:e,statusCode:i,setHeader:d.bind(e),send:n.bind(e),end:o.bind(e)}}}function CreateHttp2Context(t,e){const{method:r,url:a,headers:s}=t,{statusCode:i,write:n,end:o,setHeader:d}=e;var[u,h]=(a||"").split("?");return{reqOption:{_req:t,method:r||"",pathName:u,query:new URLSearchParams(h),fullPath:a||"",headers:s},resOption:{_res:e,statusCode:i,setHeader:d.bind(e),send:n.bind(e),end:o.bind(e)}}}class HttpFramework{serverApp;middleWareArr;data;constructor(t={}){this.serverApp=null,this.middleWareArr=[],this.data=t,this.init()}init(){let t=null;var e,r;t=this.data.http2?({key:e,cert:r}=this.data,http2__default.default.createSecureServer({key:e,cert:r},(t,e)=>{var{reqOption:t,resOption:e}=CreateHttp2Context(t,e);runMiddleWare(this.middleWareArr,t,e)})):http__default.default.createServer((t,e)=>{var{reqOption:t,resOption:e}=CreateContext(t,e);runMiddleWare(this.middleWareArr,t,e)}),this.serverApp=t}use(t){if("function"!=typeof t)throw new Error("middle ware must be a function");this.middleWareArr.push(t)}listen(t,e=()=>{}){this.serverApp?.listen(t,e)}}async function runMiddleWare(e,r,a){0===e.length&&(a.send("404 not found"),a.end());let s=0;await e[0](r,a,async function t(){e[s+1]&&(s++,await e[s](r,a,t))})}class Router{routeList;data;constructor(t={}){this.routeList=[],this.data=t}use(t){this.routeList=this.routeList.concat(t.routeList)}set(t,e,r){let a=[];var s="string"==typeof e?e.split("/").filter(t=>""!==t):[];this.data.prefix&&(a=this.data.prefix.split("/").filter(t=>""!==t)),this.routeList.push({method:t,prefix:this.data.prefix,path:""+e,pathArr:a.concat(s),businessFunc:r,param:{}})}get(t,e){this.set("GET",t,e)}put(t,e){this.set("PUT",t,e)}delete(t,e){this.set("DELETE",t,e)}post(t,e){this.set("POST",t,e)}option(t,e){this.set("OPTION",t,e)}routes(){return async(e,r,a)=>{const t=e.pathName;var s,i=t.split("/").filter(t=>""!==t);for(s of this.routeList)if(s.method===e.method)if("string"==typeof s.path){const d={},u=s.pathArr;let t=!0;if(u.length===i.length){for(var[n,o]of Object.entries(i)){n=Number(n);if(!/^\:.*$/.test(u[n])&&o!==u[n]){t=!1;break}":"===u[n][0]&&(d[u[n].substring(1,u[n].length)]=o)}if(t)return s.param=d,void(e.route=s).businessFunc(e,r,a)}}else if(s.path.test(t))return void(e.route=s).businessFunc(e,r,a);r.send("404 not found"),r.end(),await a()}}}function staticData({pathName:s="",prefix:i="",expire:n=0,cache:o=!1}){const d=fs.existsSync(s);return d||console.warn(`file static: ${s} is not exists`),async(t,e,r)=>{var a=s+i+t.pathName;if(d)if(await checkIsExists(a)){if(t.headers["if-none-match"]&&t.headers["if-none-match"]===getHash(s))return e._res.statusCode=304,void e.end();0<n&&e.setHeader("Cache-Control","max-age="+n),o&&e.setHeader("etag",getHash(s)),fs__default.default.createReadStream(a).pipe(e._res)}else e.send("404 not found"),e.end();await r()}}function getHash(t){return crypto.createHash("md5").update(t).end().digest("hex")}function checkIsExists(t){return new Promise(e=>{fs__default.default.access(t,fs.constants.F_OK,t=>{e(!t)})})}function BodyParse(){return async(e,t,r)=>{let a=Buffer.from([]);e._req.on("data",t=>{a=Buffer.concat([a,t])}),e._req.on("end",async()=>{try{var t=JSON.parse(a.toString()||"{}");e.body=t}catch{}finally{e.bodyBuf=a,await r()}})}}exports.BodyParse=BodyParse,exports.Router=Router,exports.Server=HttpFramework,exports.Static=staticData;
